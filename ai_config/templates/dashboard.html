{% extends './layout/layout1.html' %}
{% block content %}

<!-- Main content -->
<div class="rbt-main-content mr--0">
    <div class="rbt-daynamic-page-content">
        
        <!-- Dashboard Center Content -->
        <div class="rbt-dashboard-content">
            
            <div class="banner-area"></div>
            
            <div class="content-page">
                <div class="chat-box-list">

                    <div class="welcome-wrapper">
                        <div class="content-section">
                            <h4 class="title">👋 Welcome, {{user.username}}</h4>
                        </div>
                        <div>
                            <button id="analyzeBtn" class="btn btn-primary">Run AI Analysis</button>
                            <div id="status" style="margin-top: 10px;"></div>
                        </div>
                    </div>

                    <!-- <div class="rainbow-generartor-section rainbow-section-gap">
                        <div class="section-title text-center sal-animate" data-sal="slide-up" data-sal-duration="700" data-sal-delay="100">
                            <h4 class="subtitle "><span class="theme-gradient">NeuroSys AI</span></h4>
                            <h2 class="title w-600 mb--20">AI-Powered Linux Automation & Security</h2>
                            <p class="description b1">Smart. Secure. Efficient.
                            </p>
                        </div>
                       
                    </div> -->

                </div>
            </div>
            <div class="banner-area">
                <div class="row" id="row1">
                  <!-- CPU Usage Card -->
                    <div class="col-md-3 col-sm-6 col-lg-3" style="padding: 12px;">
                        <div class="card is rainbow-address bg-flashlight" style="border-radius: 14px; background: white; padding: 33px 22px; position: relative; overflow: hidden; height: 150px;">
                            <!-- Text for CPU Usage -->
                            <div class="row" style="position: relative; z-index: 2; text-align: center;">
                                <div class="col-6 text-center " style="left: 53%; top: 40%;">
                                    <h5  id="cpuUsage">0%</h5>
                                </div>
                                <div class="col-6 text-center " style="left: 55%; top: 80%;">
                                    <h5 style=" font-size: 14px; font-weight: 400;">CPU Usage</h5>
                                </div>
                                <div class="col-12 text-center" style="top: 110%; position: absolute;">
                                    <small style="font-size: 12px;" id="cpuSpecs">Cores: N/A, Frequency: N/A GHz</small>
                                </div>
                            </div>
                            <!-- Div for CPU Chart -->
                            <div id="cpuChart" style="position: absolute; left: 0; width: 100%; height: 100%; z-index: 1;"></div>
                        </div>
                    </div>

                    <!-- RAM Usage Card -->
                    <div class="col-md-3 col-sm-6 col-lg-3" style="padding: 12px;">
                        <div class="card is rainbow-address bg-flashlight" style="border-radius: 14px; background: white; padding: 33px 22px; position: relative; overflow: hidden; height: 150px;">
                            <!-- Text for RAM Usage -->
                            <div class="row" style="position: relative; z-index: 2; text-align: center;">
                                <div class="col-6 text-center " style="left: 53%; top: 40%;">
                                    <h5 style="" id="ramUsage">0%</h5>
                                </div>
                                <div class="col-6 text-center " style="left: 55%; top: 80%;">
                                    <h5 style=" font-size: 14px; font-weight: 400;">RAM Usage</h5>
                                </div>
                                <div class="col-12 text-center" style="top: 110%; position: absolute;">
                                    <small style=" font-size: 12px;" id="ramSpecs">Total: N/A GB</small>
                                </div>
                            </div>
                            <!-- Div for RAM Chart -->
                            <div id="ramChart" style="position: absolute; left: 0; width: 100%; height: 100%; z-index: 1;"></div>
                        </div>
                    </div>

                    <!-- Disk Usage Card -->
                    <div class="col-md-3 col-sm-6 col-lg-3" style="padding: 12px;">
                        <div class="card is rainbow-address bg-flashlight" style="border-radius: 14px; background: white; padding: 33px 22px; position: relative; overflow: hidden; height: 150px;">
                            <!-- Text for Disk Usage -->
                            <div class="row" style="position: relative; z-index: 2; text-align: center;">
                                <div class="col-6 text-center " style="left: 53%; top: 40%;">
                                    <h5 style="" id="diskUsage">0%</h5>
                                </div>
                                <div class="col-6 text-center " style="left: 55%; top: 80%;">
                                    <h5 style=" font-size: 14px; font-weight: 400;">Disk Usage</h5>
                                </div>
                                <div class="col-12 text-center" style="top: 110%; position: absolute;">
                                    <small style=" font-size: 12px;" id="diskSpecs">Total: N/A GB</small>
                                </div>
                            </div>
                            <!-- Div for Disk Chart -->
                            <div id="diskChart" style="position: absolute; left: 0; width: 100%; height: 100%; z-index: 1;"></div>
                        </div>
                    </div>

                    <!-- VRAM Usage Card -->
                    <div class="col-md-3 col-sm-6 col-lg-3" style="padding: 12px;">
                        <div class="card is rainbow-address bg-flashlight" style="border-radius: 14px; background: white; padding: 33px 22px; position: relative; overflow: hidden; height: 150px;">
                            <!-- Text for VRAM Usage -->
                            <div class="row" style="position: relative; z-index: 2; text-align: center;">
                                <div class="col-6 text-center " style="left: 53%; top: 40%;">
                                    <h5 style="" id="vramUsage">N/A</h5>
                                </div>
                                <div class="col-6 text-center " style="left: 55%; top: 80%;">
                                    <h5 style=" font-size: 14px; font-weight: 400;">VRAM Usage</h5>
                                </div>
                                <div class="col-12 text-center" style="top: 110%; position: absolute;">
                                    <small style=" font-size: 12px;" id="vramSpecs">Total: N/A GB</small>
                                </div>
                            </div>
                            <!-- Div for VRAM Chart -->
                            <div id="vramChart" style="position: absolute; left: 0; width: 100%; height: 100%; z-index: 1;"></div>
                        </div>
                    </div>
                </div>
                <div class="row" id="row2">

                     <!-- Network Overview Card -->
                     <div class="col-md-6 col-sm-12 col-lg-6 h-100" style="padding: 12px;">
                        <div class="card is rainbow-address bg-flashlight" style="
                            border-radius: 14px; 
                            background: linear-gradient(135deg, #ffffff, #f8f9fa); /* Subtle gradient background */
                            padding: 20px; 
                            position: relative; 
                            overflow: hidden;
                            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1), 0 1px 3px rgba(0, 0, 0, 0.06); /* Soft shadow */
                        ">
                            <!-- Title -->
                            <h4 style="
                                margin-bottom: 16px; 
                               " class="theme-gradient text-center">Network Overview</h4>
                    
                            <!-- Example: Server IP -->
                            <div class="info-row" style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                <span style=" font-size: 14px; font-weight: 500;">
                                    <i class="fas fa-server" style="margin-right: 8px;"></i>Server IP:
                                </span>
                                <span id="serverIp" style=" font-size: 14px; font-weight: 500;">Loading...</span>
                            </div>
                    
                            <!-- External IP -->
                            <div class="info-row" style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                <span style=" font-size: 14px; font-weight: 500;">External IP:</span>
                                <span id="externalIp" style=" font-size: 14px; font-weight: 500;">Loading...</span>
                            </div>
                    
                            <!-- Location -->
                            <div class="info-row" style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                <span style=" font-size: 14px; font-weight: 500;">Location:</span>
                                <span id="location" style=" font-size: 14px; font-weight: 500;">Loading...</span>
                            </div>
                    
                            <!-- ISP -->
                            <div class="info-row" style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                <span style=" font-size: 14px; font-weight: 500;">ISP:</span>
                                <span id="isp" style=" font-size: 14px; font-weight: 500;">Loading...</span>
                            </div>
                    
                            <!-- RX -->
                            <div class="info-row" style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                <span style=" font-size: 14px; font-weight: 500;">RX:</span>
                                <span id="rx" style=" font-size: 14px; font-weight: 500;" title="Received Data">Loading...</span>
                            </div>
                    
                            <!-- TX -->
                            <div class="info-row" style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                <span style=" font-size: 14px; font-weight: 500;">TX:</span>
                                <span id="tx" style=" font-size: 14px; font-weight: 500;">Loading...</span>
                            </div>
                    
                            <!-- Active Connections -->
                            <div class="info-row" style="display: flex; justify-content: space-between; margin-bottom: 16px;">
                                <span style=" font-size: 14px; font-weight: 500;">Active Connections:</span>
                                <span id="activeConnections" style=" font-size: 14px; font-weight: 500;">Loading...</span>
                            </div>
                    
                            <!-- Interactive Map -->
                            <div id="map" style="
                                height: 200px; 
                                margin-top: 10px; 
                                border-radius: 10px; 
                                overflow: hidden;
                                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
                            "></div>
                        </div>
                    </div>

                        <!-- Connected Devices Card -->
                        <div class="col-md-6 col-sm-12 col-lg-6 h-100" style="padding: 12px;">
                            <div class="col-md-12">

                                <div class="card is rainbow-address bg-flashlight" style="border-radius: 14px; background: white; padding: 20px; position: relative; overflow: hidden;">
                                    <h4 class="theme-gradient text-center">Connected Devices</h5>
                                    <table>
                                        <thead>
                                            <tr>
                                                <th style=" font-size: 14px;">IP Address</th>
                                                <th style=" font-size: 14px;">MAC Address</th>
                                                <th style=" font-size: 14px;">Hostname</th>
                                                <th style=" font-size: 14px;">Login Time</th>
                                                <th style=" font-size: 14px;">Idle Time</th>
                                                <th style=" font-size: 14px;">JCPU</th>
                                                <th style=" font-size: 14px;">PCPU</th>
                                                <th style=" font-size: 14px;">Activity</th>
                                            </tr>
                                        </thead>
                                        <tbody id="connectedDevices">
                                            <tr><td colspan="6">Fetching data...</td></tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                           
                        </div>
                        <div class="col-md-12 col-sm-12 col-lg-12 h-100" style="padding: 12px;">
                           
                                <div class="card is rainbow-address bg-flashlight" style="display: flex;flex-flow: wrap;     flex-direction: row;     flex-wrap: wrap;     justify-content: center; border-radius: 14px; background: white; padding: 20px; position: relative; overflow: hidden;">
                                    <div class="col-md-12 col-lg-12 col-sm-12">
                                    <h4 class="theme-gradient text-center">Logs and Activity</h4>
                                    </div>
                                    <div class="col-md-4 col-lg-4 col-sm-12" style="
                                    padding: 10px;
                                ">
                                        <div id="logsPolarChart" style="height: 250px; margin-bottom: 20px;"></div>
                                        <div id="logsLineChart" style="height: 250px; margin-bottom: 20px;"></div>
                                    </div>
                                    <div class="col-md-8 col-lg-8 col-sm-12"
                                    style="
    padding: 10px;
">
                                        <table id="logsTable" class="display" style="width: 100%;">
                                            <thead>
                                                <tr>
                                                    <th>Timestamp</th>
                                                    <th>Message</th>
                                                    <th>Severity</th>
                                                    <th>Source IP</th>
                                                    <th>Destination IP</th>
                                                    <th>Protocol</th>
                                                    <th>Classification</th>
                                                </tr>
                                            </thead>
                                            <tbody></tbody>
                                        </table>
                                    </div>
                                   
                                </div>
                            
                        </div>
                       
                    <!-- Network Connections Card -->
                    <div class="col-md-6 col-sm-12 col-lg-6" style="padding: 12px;">
                        <div class="card is rainbow-address bg-flashlight" style="border-radius: 14px; background: white; display: flex; padding: 20px; align-items: center; gap: 10px; flex: 1 0 0; overflow: hidden;">
                            <h4 style="" class="theme-gradient">Network Connections</h4>
                            <!-- Add a search input field -->
                            <input type="text" id="searchInput" placeholder="Search connections..." style="padding: 8px; border-radius: 14px; border: 1px solid #ccc;  width: 100%;  margin-bottom: 10px;">
                            <div id="networkStatusTable" style="width: 100%; overflow-x: auto;">
                                <table style="width: 100%; border-collapse: collapse;">
                                    <thead>
                                        <tr>
                                            <th style=" font-size: 14px; ">Netid</th>
                                            <th style=" font-size: 14px; ">State</th>
                                            <th style=" font-size: 14px; ">Recv-Q</th>
                                            <th style=" font-size: 14px; ">Send-Q</th>
                                            <th style=" font-size: 14px; ">Local Address:Port</th>
                                            <th style=" font-size: 14px; ">Peer Address:Port</th>
                                            <th style=" font-size: 14px; ">Process</th>
                                        </tr>
                                    </thead>
                                    <tbody id="networkConnections" style="font-size: 14px;">
                                        <!-- Rows will be inserted here by JavaScript -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
            
                    <!-- Running Services Card -->
                  <!-- Running Services Card -->
                    <div class="col-md-6 col-sm-12 col-lg-6" style="padding: 12px;">
                        <div class="card is rainbow-address bg-flashlight" style="border-radius: 14px; background: white; display: flex; padding: 20px; align-items: center; gap: 10px; flex: 1 0 0; overflow: hidden;">
                            <h4 style="" class="theme-gradient">Running Services</h4>
                            <!-- Add a search input field -->
                            <input type="text" id="serviceSearchInput" placeholder="Search services..." style="padding: 8px; border-radius: 14px; border: 1px solid #ccc; width: 100%; margin-bottom: 10px;">
                            <div id="serviceStatusTable" style="width: 100%; overflow-x: auto;">
                                <table style="width: 100%; border-collapse: collapse; font-size: 14px;">
                                    <thead>
                                        <tr>
                                            <th>Name</th>
                                            <th>Status</th>
                                            <th>Description</th>
                                        </tr>
                                    </thead>
                                    <tbody id="serviceConnections"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                  
                </div>
                
            </div>
           
        </div>

    </div>
</div>

{% endblock content %}
{% block script %}
<!-- Jika menggunakan CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://code.highcharts.com/highcharts.js"></script>
<script src="https://code.highcharts.com/highcharts-more.js"></script>
<script src="https://code.highcharts.com/modules/solid-gauge.js"></script>
<script src="https://cdn.jsdelivr.net/npm/luxon/build/global/luxon.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Leaflet.awesome-markers/2.0.2/leaflet.awesome-markers.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/Leaflet.awesome-markers/2.0.2/leaflet.awesome-markers.min.js"></script>
<script>
   async function fetchGeolocation(ip) {
        const maxRetries = 3;
        for (let attempt = 1; attempt <= maxRetries; attempt++) {
            try {
                const response = await fetch(`/fetch_geolocation/?ip=${ip}`);
                if (!response.ok) {
                    const errorData = await response.json();
                    console.error(`Attempt ${attempt}: ${errorData.error}`);
                    throw new Error(errorData.error);
                }
                const data = await response.json();
                return {
                    location: `${data.city}, ${data.region}, ${data.country_name}`,
                    isp: data.org,
                    latitude: data.latitude,
                    longitude: data.longitude,
                };
            } catch (error) {
                console.error(`Attempt ${attempt} failed: ${error.message}`);
                if (attempt === maxRetries) {
                    return {
                        location: "Unknown",
                        isp: "Unknown",
                        latitude: null,
                        longitude: null,
                    };
                }
                await new Promise(resolve => setTimeout(resolve, 1000)); // Wait 1 second before retrying
            }
        }
    }
    function initializeMap(latitude, longitude, external_ip) {
        const mapDiv = document.getElementById('map');
        if (!mapDiv._leaflet_map) { // Check if the map is already initialized
            var map = L.map('map').setView([latitude, longitude], 13);

            L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
                subdomains: 'abcd',
                maxZoom: 19
            }).addTo(map);
            var awesomeIcon = L.AwesomeMarkers.icon({
                icon: 'fa-location-dot',
                markerColor: 'blue',
                prefix: 'fa',
                iconColor: 'white'
            });

            L.marker([latitude, longitude], { icon: awesomeIcon }).addTo(map)
                .bindPopup(external_ip)
                .openPopup();
           
            mapDiv._leaflet_map = map; // Store the map instance
        } else {
            mapDiv._leaflet_map.setView([latitude, longitude], 13); // Update the map view
        }
    }
    function updateConnectedDevices(data) {
        let deviceList = document.getElementById('connectedDevices');
            if (deviceList) {
                deviceList.innerHTML = ""; // Clear previous content
                if (data.network_overview.connected_devices.length > 0) {
                    data.network_overview.connected_devices.forEach(device => {
                        let row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${device.ip}</td>
                            <td>${device.mac}</td>
                            <td>${device.hostname}</td>
                            <td>${device.login}</td>
                            <td>${device.idle}</td>
                            <td>${device.jcpu}</td>
                            <td>${device.pcpu}</td>
                            <td>${device.what}</td>
                        `;
                        deviceList.appendChild(row);
                    });
                } else {
                    deviceList.innerHTML = `<tr><td colspan="8">No connected devices found.</td></tr>`;
                }
            }
    }

    const isLocal = window.location.hostname === "localhost" || window.location.hostname.startsWith("192.168.");
    const wsProtocol = isLocal ? "ws" : "wss";
    const wsHost = isLocal ? "192.168.101.20:8000" : "experimental.rahmn.tech";

    const socket = new WebSocket(`${wsProtocol}://${wsHost}/ws/system_monitor/`);
    socket.onmessage = async function(event) {
        const data = JSON.parse(event.data);

             // Update CPU usage and specs
            document.getElementById('cpuUsage').innerText = data.cpu + "%";
            document.getElementById('cpuSpecs').innerText = `Cores: ${data.cpu_info.cores}, Frequency: ${data.cpu_info.frequency} GHz`;

            // Update RAM usage and specs
            document.getElementById('ramUsage').innerText = data.ram + "%";
            document.getElementById('ramSpecs').innerText = `Total: ${data.ram_info.total} GB`;

            // Update Disk usage and specs
            document.getElementById('diskUsage').innerText = data.disk + "%";
            document.getElementById('diskSpecs').innerText = `Total: ${data.disk_info.total} GB`;

            // Update VRAM usage and specs
            document.getElementById('vramUsage').innerText = data.vram !== "N/A" ? data.vram + "%" : "N/A";
            document.getElementById('vramSpecs').innerText = `Total: ${data.vram_info.total} GB`;
            
            const now = new Date();
            const timeLabel = `${now.getHours()}:${now.getMinutes()}:${now.getSeconds()}`;
            timeLabels.push(timeLabel);
            cpuData.push(data.cpu);
            ramData.push(data.ram);
            diskData.push(data.disk);
            vramData.push(data.vram !== "N/A" ? data.vram : 0);

            // Keep only the last 10 data points
            if (timeLabels.length > 10) {
                timeLabels.shift();
                cpuData.shift();
                ramData.shift();
                diskData.shift();
                vramData.shift();
            }

            // Update charts
            if (cpuChart && cpuChart.series) cpuChart.series[0].setData([data.cpu]);
            if (ramChart && ramChart.series) ramChart.series[0].setData([data.ram]);
            if (diskChart && diskChart.series) diskChart.series[0].setData([data.disk]);
            if (vramChart && vramChart.series && data.vram !== "N/A") vramChart.series[0].setData([data.vram]);
            // Format network connections and services for better readability
            // document.getElementById('networkStatus').innerText = formatOutput(data.network);
            formatOutputTable(data.network);
            formatServices(data.services);
            // document.getElementById('serviceStatus').innerText = formatOutput(data.services);

                // Update Network Overview
             // Update Network Overview
            document.getElementById('serverIp').innerText = data.network_overview.server_ip;
            document.getElementById('externalIp').innerText = data.network_overview.external_ip;

            // Update Geolocation Data
            const geolocation = data.network_overview.geolocation || {};
            document.getElementById('location').innerText = `${geolocation.city}, ${geolocation.region}, ${geolocation.country_name} ` || "Unknown";
            document.getElementById('isp').innerText = geolocation.org || "Unknown";
            document.getElementById('rx').innerText = data.network_overview.rx + " KB";
            document.getElementById('tx').innerText = data.network_overview.tx + " KB";
            document.getElementById('activeConnections').innerText = data.network_overview.active_connections;


            // Initialize or update the map
            if (geolocation.latitude && geolocation.longitude) {
                initializeMap(geolocation.latitude, geolocation.longitude, data.network_overview.external_ip);
            }

            // Update Connected Devices Table
            updateConnectedDevices(data);

    };

    socket.onclose = function() {
        console.error("WebSocket Closed. Trying to reconnect...");
        setTimeout(() => location.reload(), 5000);
    };

    
    function formatOutputTable(text) {
            const lines = text.split("\n").slice(1); // Skip the header line
            const tbody = document.getElementById('networkConnections');
            tbody.innerHTML = ''; // Clear previous content

            lines.forEach(line => {
                if (line.trim() === '') return; // Skip empty lines

                const columns = line.split(/\s+/); // Split by whitespace
                const row = document.createElement('tr');

                // Netid
                const netid = document.createElement('td');
                netid.textContent = columns[0];
                row.appendChild(netid);

                // State
                const state = document.createElement('td');
                state.textContent = columns[1];
                row.appendChild(state);

                // Recv-Q
                const recvQ = document.createElement('td');
                recvQ.textContent = columns[2];
                row.appendChild(recvQ);

                // Send-Q
                const sendQ = document.createElement('td');
                sendQ.textContent = columns[3];
                row.appendChild(sendQ);

                // Local Address:Port
                const localAddress = document.createElement('td');
                localAddress.textContent = columns[4];
                row.appendChild(localAddress);

                // Peer Address:Port
                const peerAddress = document.createElement('td');
                peerAddress.textContent = columns[5];
                row.appendChild(peerAddress);

                // Process
                const process = document.createElement('td');
                process.textContent = columns.slice(6).join(' '); // Join the remaining columns
                row.appendChild(process);

                tbody.appendChild(row);
            });

            // Apply the search filter after updating the table
            filterTable();
        }
        function formatServices(services) {
            const tbody = document.getElementById('serviceConnections');
            tbody.innerHTML = ''; // Clear previous content
            services.forEach(service => {
                const row = document.createElement('tr');

                    // Service Name
                    const serviceName = document.createElement('td');
                    serviceName.textContent = service.name;
                    row.appendChild(serviceName);

                    // Status
                    const status = document.createElement('td');
                    status.textContent = service.status;
                    row.appendChild(status);

                    // Description
                    const description = document.createElement('td');
                    description.textContent = service.description || "N/A";
                    row.appendChild(description);
                    tbody.appendChild(row);
                });
            // Apply the search filter after updating the table
            filterServiceTable();
        }

        // Function to filter services table rows based on search input
        function filterServiceTable() {
            const searchInput = document.getElementById('serviceSearchInput');
            const filter = searchInput.value.toLowerCase(); // Get the search term and convert to lowercase
            const rows = document.querySelectorAll('#serviceConnections tr'); // Get all table rows

            rows.forEach(row => {
                const cells = row.querySelectorAll('td'); // Get all cells in the row
                let match = false;

                // Check if any cell in the row matches the search term
                cells.forEach(cell => {
                    if (cell.textContent.toLowerCase().includes(filter)) {
                        match = true;
                    }
                });

                // Show or hide the row based on whether it matches the search term
                if (match) {
                    row.style.display = ''; // Show the row
                } else {
                    row.style.display = 'none'; // Hide the row
                }
            });
        }

        // Add an event listener to the services search input
        document.getElementById('serviceSearchInput').addEventListener('input', filterServiceTable);
    // Function to filter table rows based on search input
    function filterTable() {
        const searchInput = document.getElementById('searchInput');
        const filter = searchInput.value.toLowerCase(); // Get the search term and convert to lowercase
        const rows = document.querySelectorAll('#networkConnections tr'); // Get all table rows

        rows.forEach(row => {
            const cells = row.querySelectorAll('td'); // Get all cells in the row
            let match = false;

            // Check if any cell in the row matches the search term
            cells.forEach(cell => {
                if (cell.textContent.toLowerCase().includes(filter)) {
                    match = true;
                }
            });

            // Show or hide the row based on whether it matches the search term
            if (match) {
                row.style.display = ''; // Show the row
            } else {
                row.style.display = 'none'; // Hide the row
            }
        });
    }

    // Add an event listener to the search input
    document.getElementById('searchInput').addEventListener('input', filterTable);

    function formatOutput(text) {
        return text.split("\n").slice(0, 100).join("\n"); // Show only the first 10 lines for readability
    }

    let cpuChart, ramChart, vramChart, diskChart;
    let timeLabels = []; // Array to store time labels
    let cpuData = []; // Array to store CPU usage data
    let ramData = []; // Array to store RAM usage data
    let vramData = []; // Array to store VRAM usage data
    let diskData = [];
  
    function initializeCharts() {
    console.log("Initializing charts...");

    const gaugeOptions = {
        chart: {
            type: 'solidgauge',
            backgroundColor: 'transparent',
            height: 100,
        },
        title: { text: null },
        pane: {
            center: ['50%', '50%'],
            size: '100%',
            startAngle: -90,
            endAngle: 90,
            background: {
                backgroundColor: '#EEE',
                innerRadius: '60%',
                outerRadius: '100%',
                shape: 'arc',
            },
        },
        tooltip: {
            enabled: false,
        },
        yAxis: {
            min: 0,
            max: 100,
            lineWidth: 0,
            tickPositions: [],
        },
        plotOptions: {
            solidgauge: {
                dataLabels: {
                    y: 5,
                    borderWidth: 0,
                    useHTML: true,
                },
            },
        },
    };

    // CPU Gauge
    cpuChart = Highcharts.chart('cpuChart', {
        ...gaugeOptions,
        yAxis: {
            ...gaugeOptions.yAxis,
            stops: [
                [0.1, '#FF6384'], // Red
                [0.5, '#FFA500'], // Orange
                [0.9, '#36A2EB'], // Blue
            ],
        },
        series: [{
            name: 'CPU Usage',
            data: [0],
           
        }],
    });

    // RAM Gauge
    ramChart = Highcharts.chart('ramChart', {
        ...gaugeOptions,
        yAxis: {
            ...gaugeOptions.yAxis,
            stops: [
                [0.1, '#36A2EB'], // Blue
                [0.5, '#FFA500'], // Orange
                [0.9, '#FF6384'], // Red
            ],
        },
        series: [{
            name: 'RAM Usage',
            data: [0],
            
        }],
    });

    // Disk Gauge
    diskChart = Highcharts.chart('diskChart', {
        ...gaugeOptions,
        yAxis: {
            ...gaugeOptions.yAxis,
            stops: [
                [0.1, '#FFA500'], // Orange
                [0.5, '#FF6384'], // Red
                [0.9, '#36A2EB'], // Blue
            ],
        },
        series: [{
            name: 'Disk Usage',
            data: [0],
            //dataLabels: {
            //    format: '<div style="text-align:center"><span style="font-size:16px;color:white">{y}%</span></div>',
            //},
        }],
    });

    // VRAM Gauge
    vramChart = Highcharts.chart('vramChart', {
        ...gaugeOptions,
        yAxis: {
            ...gaugeOptions.yAxis,
            stops: [
                [0.1, '#4BC0C0'], // Teal
                [0.5, '#FFA500'], // Orange
                [0.9, '#FF6384'], // Red
            ],
        },
        series: [{
            name: 'VRAM Usage',
            data: [0],
          //  dataLabels: {
        //        format: '<div style="text-align:center"><span style="font-size:16px;color:white">{y}%</span></div>',
         //   },
        }],
    });
   
}
let logsData = [];
let filteredLogs = [];
async function fetchLogs() {
    try {
        const response = await fetch('/api/v1/suricata-logs/');
        if (!response.ok) {
            throw new Error('Failed to fetch logs');
        }
        const data = await response.json();
        logsData = data;
        updateLogsPolarChart();
        updateLogsLineChart();
        initializeDataTables(); // Inisialisasi Tabulator setelah data diterima
    } catch (error) {
        console.error('Error fetching logs:', error);
    }
}
function initializeDataTables() {
    const table = $('#logsTable').DataTable({
        data: logsData,
        columns: [
            { data: "timestamp", render: (data) => new Date(data).toLocaleString() },
            { data: "message" },
            { data: "severity" },
            { data: "source_ip" },
            { data: "destination_ip" },
            { data: "protocol" },
            { data: "classification" },
        ],
        paging: true, // Aktifkan paginasi
        searching: true, // Aktifkan pencarian
        ordering: true, // Aktifkan pengurutan
        pageLength: 5, // Jumlah baris per halaman
    });
}
// Inisialisasi doughnut chart untuk logs
let logsPolarChart;

function initializeLogsPolarChart() {
    logsPolarChart = Highcharts.chart('logsPolarChart', {
        chart: {
            polar: true,
            type: 'column',
            backgroundColor: 'transparent',
        },
        title: {
            text: 'Logs by Classification',
            align: 'center'
        },
        pane: {
            size: '80%'
        },
        xAxis: {
            categories: [],
            tickmarkPlacement: 'on',
            lineWidth: 0
        },
        yAxis: {
            gridLineInterpolation: 'polygon',
            lineWidth: 0,
            min: 0
        },
        tooltip: {
            shared: true,
            pointFormat: '<span style="color:{series.color}">{series.name}: <b>{point.y}</b><br/>'
        },
        plotOptions: {
            column: {
                pointPadding: 0,
                groupPadding: 0
            }
        },
        series: [{
            name: 'Log Count',
            data: [],
            pointPlacement: 'on'
        }]
    });
}
let logsLineChart;

function initializeLogsLineChart() {
    logsLineChart = Highcharts.chart('logsLineChart', {
        chart: {
            type: 'line',
            backgroundColor: 'transparent',
        },
        title: {
            text: 'Logs Over Time'
        },
        xAxis: {
            type: 'datetime',
            title: {
                text: 'Time'
            }
        },
        yAxis: {
            title: {
                text: 'Number of Logs'
            }
        },
        tooltip: {
            shared: true,
            crosshairs: true,
            xDateFormat: '%Y-%m-%d %H:%M:%S'
        },
        plotOptions: {
            line: {
                marker: {
                    enabled: true
                }
            }
        },
        series: [{
            name: 'Log Count',
            data: [],
            color: '#36A2EB'
        }]
    });
}

function updateLogsPolarChart() {
    const classificationCounts = {};
    logsData.forEach(log => {
        const key = log.classification || 'Unknown';
        classificationCounts[key] = (classificationCounts[key] || 0) + 1;
    });

    const categories = Object.keys(classificationCounts);
    const counts = categories.map(cat => classificationCounts[cat]);

    if (logsPolarChart) {
        logsPolarChart.xAxis[0].setCategories(categories);
        logsPolarChart.series[0].setData(counts);
    }
}
function updateLogsLineChart() {
    const logTimestamps = {};
    
    logsData.forEach(log => {
        // Gunakan Luxon
        const { DateTime } = luxon;
        const luxDate = DateTime.fromISO(log.timestamp);
        
        if (!luxDate.isValid) return;

        const dateKey = luxDate.toFormat("yyyy-MM-dd HH:mm:ss"); // Bisa juga gunakan "yyyy-MM-dd"
        const roundedToMinute = luxDate.set({ second: 0, millisecond: 0 }).toMillis(); // Agar lebih rapi
        
        if (logTimestamps[roundedToMinute]) {
            logTimestamps[roundedToMinute]++;
        } else {
            logTimestamps[roundedToMinute] = 1;
        }
    });

    const sortedDates = Object.keys(logTimestamps).map(Number).sort(); // Urutkan berdasarkan waktu
    const seriesData = sortedDates.map(time => [time, logTimestamps[time]]);

    if (logsLineChart) {
        logsLineChart.series[0].setData(seriesData);
    }
}


document.addEventListener("DOMContentLoaded", function () {
    initializeCharts();
    initializeLogsPolarChart();
    initializeLogsLineChart(); 
    fetchLogs();
});

$("#analyzeBtn").click(function () {
    var button = $(this);
    var originalText = button.text();

    // Ganti teks tombol & disable
    button.text("Running...").prop("disabled", true);
    $("#status").text("AI analysis is running...").css("color", "orange");

    // Kirim request AJAX
    $.get("/run-analysis/", function(response) {
        console.log("✅ Analisis selesai:", response.status);

        // Kembalikan tombol ke keadaan awal
        button.text(originalText).prop("disabled", false);
        $("#status").text("Analysis completed successfully.").css("color", "green");

        // (Opsional) reload halaman setelah selesai
        // location.reload();

    }).fail(function(error) {
        console.error("❌ Error saat menjalankan analisis:", error.responseText);
        button.text(originalText).prop("disabled", false);
        $("#status").text("Error occurred during analysis.").css("color", "red");
    });
});
</script>
{% endblock %}